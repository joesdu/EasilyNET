# EasilyNET.Ipc 测试项目说明

这里包含了两个完整的测试项目，用于验证 EasilyNET.Ipc 框架的所有功能。

## 项目结构

```
sample/
├── EasilyNET.Ipc.Server.Sample/     # IPC 服务端项目
│   ├── Commands/                    # 命令定义和处理器
│   │   ├── UserCommands.cs         # 用户管理相关命令
│   │   └── TestCommands.cs         # 测试相关命令（数学计算、延时、错误测试等）
│   ├── Models/                      # 数据模型
│   │   └── User.cs                 # 用户相关数据模型
│   ├── Program.cs                   # 服务端主程序
│   ├── appsettings.json            # 配置文件
│   └── EasilyNET.Ipc.Server.Sample.csproj
│
└── EasilyNET.Ipc.Client.Sample/     # IPC 客户端项目
    ├── Commands/                    # 客户端命令定义
    │   └── IpcCommands.cs          # 客户端使用的命令定义
    ├── IpcTestRunner.cs            # 测试运行器
    ├── Program.cs                   # 客户端主程序
    ├── appsettings.json            # 配置文件
    └── EasilyNET.Ipc.Client.Sample.csproj
```

## 测试功能

### ✅ 基础功能测试

- **Echo 命令测试**: 测试基本的消息回显功能
- **连接稳定性测试**: 验证客户端与服务端的连接是否稳定

### ✅ 用户管理功能测试

- **创建用户**: 测试用户创建功能
- **获取用户**: 测试根据 ID 获取用户信息
- **更新用户**: 测试用户信息更新功能
- **删除用户**: 测试用户删除功能（软删除和硬删除）
- **获取所有用户**: 测试批量获取用户列表

### ✅ 数学计算测试

- **四则运算**: 测试加、减、乘、除运算
- **异常处理**: 测试除零等异常情况

### ✅ 性能与并发测试

- **延时命令**: 测试长时间运行的命令处理
- **并发性能测试**: 测试多个并发请求的处理能力
- **超时处理**: 测试命令超时机制

### ✅ 错误处理测试

- **异常传播**: 测试服务端异常如何传播到客户端
- **重试机制**: 测试失败重试功能
- **熔断器**: 测试熔断器保护机制

### ✅ 系统功能测试

- **服务器状态查询**: 获取服务器运行状态和统计信息
- **资源管理**: 测试连接池和资源释放

## 如何运行测试

### 1. 启动服务端

在第一个终端窗口中运行：

```bash
cd sample\EasilyNET.Ipc.Server.Sample
dotnet run
```

服务端将显示以下信息：

- ✅ 支持的所有命令类型
- 🌐 IPC 通信配置信息
- 📍 管道名称和套接字路径

### 2. 启动客户端

在第二个终端窗口中运行：

```bash
cd sample\EasilyNET.Ipc.Client.Sample
dotnet run
```

客户端将自动执行所有测试用例并显示结果。

## 配置说明

两个项目共享相同的配置结构（`appsettings.json`）：

```json
{
  "Ipc": {
    "PipeName": "EasilyNET_IPC_Test", // Windows 命名管道名称
    "UnixSocketPath": "/tmp/easilynet_ipc_test.sock", // Linux Unix Socket 路径
    "TransportCount": 4, // 传输层实例数
    "MaxServerInstances": 4, // 服务端最大实例数
    "ClientPipePoolSize": 2, // 客户端连接池大小
    "DefaultTimeout": "00:00:30", // 默认超时时间
    "RetryPolicy": {
      // 重试策略配置
      "MaxAttempts": 5,
      "InitialDelay": "00:00:01",
      "BackoffType": "Exponential",
      "UseJitter": true
    },
    "CircuitBreaker": {
      // 熔断器配置
      "FailureRatio": 0.5,
      "MinimumThroughput": 5,
      "BreakDuration": "00:00:30"
    }
  }
}
```

## 测试结果解释

客户端运行时会显示每个测试的结果：

- ✅ **测试通过**: 功能正常工作
- ❌ **测试失败**: 功能存在问题，会显示详细错误信息
- ⚡ **性能测试**: 显示吞吐量、平均延时等性能指标

### 典型的成功输出示例：

```
=== EasilyNET.Ipc Client Sample ===
正在启动 IPC 客户端测试...
✅ 客户端已启动，开始测试...

🔗 基本连接测试
   ✅ 测试通过

📢 Echo命令测试
   ✅ Echo 'Hello' -> 成功
   ✅ Echo 'World' -> 成功
   ✅ 测试通过

👤 用户管理测试
   ✅ 创建用户成功
   ✅ 获取用户成功
   ✅ 更新用户成功
   ✅ 获取所有用户成功
   ✅ 删除用户成功
   ✅ 测试通过

🧮 数学计算测试
   ✅ 加法成功: 10 + 5 = 15
   ✅ 测试通过

⏱️ 延时命令测试
   ✅ 延时命令成功, 实际延时: 2003.45ms
   ✅ 测试通过

❌ 错误处理测试
   ✅ 错误处理测试成功: 这是一个参数异常测试
   ✅ 测试通过

📊 服务器状态测试
   ✅ 获取服务器状态成功, 运行时间: 00:02:15.123
   ✅ 测试通过

⚡ 性能测试
   📊 性能测试结果:
      总数: 100
      成功: 100
      失败: 0
      总耗时: 1234ms
      平均耗时: 12.34ms
      吞吐量: 81.03 req/s

🎯 所有测试完成！
```

## 故障排查

### 常见问题

1. **连接失败**

   - 确保服务端已启动并正在监听
   - 检查防火墙设置
   - 验证管道名称/套接字路径配置一致

2. **权限问题**

   - Windows: 确保有访问命名管道的权限
   - Linux: 确保有访问 Unix 套接字文件的权限

3. **超时问题**
   - 调整配置文件中的超时设置
   - 检查网络延迟
   - 确认服务端处理能力

### 日志查看

项目配置了详细的日志记录，可以通过日志了解详细的执行过程和错误信息。

## 扩展测试

您可以通过以下方式扩展测试：

1. **添加新的命令类型**: 在 `Commands` 目录中添加新的命令定义和处理器
2. **修改测试参数**: 调整性能测试的并发数、延时时间等参数
3. **添加新的测试场景**: 在 `IpcTestRunner` 中添加新的测试方法

这个测试项目提供了完整的 IPC 框架功能验证，确保在各种场景下都能正常工作。
