<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridFS ç¤ºä¾‹</title>
    <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }

            .container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }

            h1 {
                color: #333;
                margin-bottom: 10px;
                font-size: 28px;
            }

            .subtitle {
                color: #666;
                margin-bottom: 30px;
                font-size: 14px;
            }

            .upload-section,
            .download-section {
                margin-bottom: 40px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            h2 {
                color: #667eea;
                margin-bottom: 20px;
                font-size: 20px;
            }

            .file-input-wrapper {
                position: relative;
                overflow: hidden;
                display: inline-block;
                margin-bottom: 20px;
            }

            .file-input-wrapper input[type=file] {
                position: absolute;
                left: -9999px;
            }

            .file-input-label {
                padding: 12px 24px;
                background: #667eea;
                color: white;
                border-radius: 6px;
                cursor: pointer;
                transition: background 0.3s;
                display: inline-block;
            }

            .file-input-label:hover {
                background: #5568d3;
            }

            .file-name {
                display: inline-block;
                margin-left: 15px;
                color: #666;
                font-size: 14px;
            }

            .controls {
                margin-top: 20px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            button {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
                font-weight: 500;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover:not(:disabled) {
                background: #5568d3;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .btn-warning {
                background: #f59e0b;
                color: white;
            }

            .btn-warning:hover:not(:disabled) {
                background: #d97706;
            }

            .btn-success {
                background: #10b981;
                color: white;
            }

            .btn-success:hover:not(:disabled) {
                background: #059669;
            }

            .btn-danger {
                background: #ef4444;
                color: white;
            }

            .btn-danger:hover:not(:disabled) {
                background: #dc2626;
            }

            .progress-container {
                margin-top: 20px;
            }

            .progress-bar-wrapper {
                width: 100%;
                height: 30px;
                background: #e5e7eb;
                border-radius: 15px;
                overflow: hidden;
                margin-bottom: 15px;
                position: relative;
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                width: 0%;
                transition: width 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 12px;
                font-weight: bold;
            }

            .status-info {
                background: white;
                padding: 15px;
                border-radius: 6px;
                border-left: 4px solid #667eea;
            }

            .status-info div {
                margin: 5px 0;
                font-size: 14px;
                color: #333;
            }

            .status-info strong {
                color: #667eea;
                min-width: 100px;
                display: inline-block;
            }

            .download-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 6px;
                font-size: 14px;
                margin-bottom: 15px;
                transition: border-color 0.3s;
            }

            .download-input:focus {
                outline: none;
                border-color: #667eea;
            }

            .video-section {
                margin-top: 30px;
            }

            video {
                width: 100%;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .alert {
                padding: 12px;
                border-radius: 6px;
                margin-top: 15px;
                font-size: 14px;
            }

            .alert-success {
                background: #d1fae5;
                color: #065f46;
                border: 1px solid #10b981;
            }

            .alert-error {
                background: #fee2e2;
                color: #991b1b;
                border: 1px solid #ef4444;
            }

            .alert-info {
                background: #dbeafe;
                color: #1e40af;
                border: 1px solid #3b82f6;
            }
        </style>
</head>

<body>
<div class="container">
    <h1>ğŸ“¤ GridFS ç¤ºä¾‹</h1>
    <p class="subtitle">æ”¯æŒå¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ ã€æš‚åœæ¢å¤ã€æ–­ç‚¹ç»­ä¼ </p>

    <!-- ä¸Šä¼ éƒ¨åˆ† -->
    <div class="upload-section">
        <h2>æ–‡ä»¶ä¸Šä¼ </h2>

        <div class="file-input-wrapper">
            <input type="file" id="fileInput"/>
            <label for="fileInput" class="file-input-label">ğŸ“ é€‰æ‹©æ–‡ä»¶</label>
            <span class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn-primary">å¼€å§‹ä¸Šä¼ </button>
            <button id="pauseBtn" class="btn-warning" disabled>æš‚åœ</button>
            <button id="resumeBtn" class="btn-success" disabled>æ¢å¤</button>
            <button id="cancelBtn" class="btn-danger" disabled>å–æ¶ˆ</button>
        </div>

        <div class="progress-container" id="uploadProgress" style="display: none;">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="status-info">
                <div>
                    <strong>çŠ¶æ€:</strong> <span id="uploadStatus">å‡†å¤‡ä¸­...</span>
                </div>
                <div>
                    <strong>è¿›åº¦:</strong> <span id="uploadPercentage">0%</span>
                </div>
                <div>
                    <strong>å·²ä¸Šä¼ :</strong> <span id="uploadedSize">0 B</span> / <span id="totalSize">0 B</span>
                </div>
                <div>
                    <strong>ä¸Šä¼ é€Ÿåº¦:</strong> <span id="uploadSpeed">0 B/s</span>
                </div>
                <div>
                    <strong>é¢„è®¡å‰©ä½™:</strong> <span id="remainingTime">--</span>
                </div>
            </div>
        </div>

        <div id="uploadAlert" style="display: none;"></div>
    </div>

    <!-- ä¸‹è½½éƒ¨åˆ† -->
    <div class="download-section">
        <h2>æ–‡ä»¶ä¸‹è½½ (æ–­ç‚¹ç»­ä¼ )</h2>

        <input type="text" id="fileIdInput" class="download-input"
               placeholder="è¾“å…¥æ–‡ä»¶ ID (å¦‚: 507f1f77bcf86cd799439011)"/>

        <div class="controls">
            <button id="downloadBtn" class="btn-primary">å¼€å§‹ä¸‹è½½</button>
            <button id="cancelDownloadBtn" class="btn-danger" disabled>å–æ¶ˆä¸‹è½½</button>
        </div>

        <div class="progress-container" id="downloadProgress" style="display: none;">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="downloadProgressBar">0%</div>
            </div>
            <div class="status-info">
                <div>
                    <strong>å·²ä¸‹è½½:</strong> <span id="downloadedSize">0 B</span> /
                    <span id="downloadTotalSize">
                        0
                        B
                    </span>
                </div>
                <div>
                    <strong>è¿›åº¦:</strong> <span id="downloadPercentage">0%</span>
                </div>
            </div>
        </div>

        <div id="downloadAlert" style="display: none;"></div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾æµ‹è¯• -->
    <div class="video-section">
        <h2>ğŸ¬ è§†é¢‘æµå¼æ’­æ”¾æµ‹è¯•</h2>
        <p class="subtitle">è¾“å…¥è§†é¢‘æ–‡ä»¶ ID,æµ‹è¯•èŒƒå›´è¯·æ±‚å’Œæ‹–åŠ¨åŠŸèƒ½</p>

        <input type="text" id="videoFileId" class="download-input" placeholder="è¾“å…¥è§†é¢‘æ–‡ä»¶ ID"/>

        <button id="loadVideoBtn" class="btn-primary">åŠ è½½è§†é¢‘</button>

        <video id="videoPlayer" controls style="margin-top: 20px; display: none;">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
        </video>
    </div>
</div>

<script type="module">
            import {
                GridFSUploader,
                GridFSDownloader,
                formatFileSize,
                formatTime
            } from './easilynet-gridfs-sdk.js';

            let uploader = null;
            let downloader = null;

            // DOM å…ƒç´ 
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadPercentage = document.getElementById('uploadPercentage');
            const uploadedSize = document.getElementById('uploadedSize');
            const totalSize = document.getElementById('totalSize');
            const uploadSpeed = document.getElementById('uploadSpeed');
            const remainingTime = document.getElementById('remainingTime');
            const uploadAlert = document.getElementById('uploadAlert');

            // ä¸‹è½½ç›¸å…³å…ƒç´ 
            const fileIdInput = document.getElementById('fileIdInput');
            const downloadBtn = document.getElementById('downloadBtn');
            const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
            const downloadProgress = document.getElementById('downloadProgress');
            const downloadProgressBar = document.getElementById('downloadProgressBar');
            const downloadedSize = document.getElementById('downloadedSize');
            const downloadTotalSize = document.getElementById('downloadTotalSize');
            const downloadPercentage = document.getElementById('downloadPercentage');
            const downloadAlert = document.getElementById('downloadAlert');

            // è§†é¢‘ç›¸å…³å…ƒç´ 
            const videoFileId = document.getElementById('videoFileId');
            const loadVideoBtn = document.getElementById('loadVideoBtn');
            const videoPlayer = document.getElementById('videoPlayer');

            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
                    startBtn.disabled = false;
                }
            });

            // å¼€å§‹ä¸Šä¼ 
            startBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) return;

                uploader = new GridFSUploader(file, {
                    // url: 'https://api.example.com', // å¯é€‰: å¦‚æœåç«¯ä¸åœ¨å½“å‰åŸŸ,è¯·å¡«å†™åŸŸå
                    chunkSize: 1024 * 1024, // 1MB
                    maxConcurrent: 3,
                    onProgress: (progress) => {
                        uploadProgress.style.display = 'block';
                        const percentValue = (progress.status === 'hashing' && typeof progress.hashPercentage === 'number')
                            ? progress.hashPercentage
                            : progress.percentage;
                        const percent = percentValue.toFixed(2);
                        progressBar.style.width = `${percent}%`;
                        progressBar.textContent = `${percent}%`;

                        // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬
                        if (progress.status === 'merging') {
                            uploadStatus.textContent = 'åˆå¹¶æ–‡ä»¶ä¸­,è¯·ç¨å€™...';
                            uploadSpeed.textContent = '--';
                            remainingTime.textContent = 'æ­£åœ¨å¤„ç†';
                        } else if (progress.status === 'hashing') {
                            uploadStatus.textContent = `æ­£åœ¨è®¡ç®—æ–‡ä»¶ç‰¹å¾å€¼(Hash)... ${percent}%`;
                            uploadSpeed.textContent = '--';
                            remainingTime.textContent = 'è¯·ç¨å€™';
                        } else if (progress.status === 'completed') {
                            uploadStatus.textContent = 'ç§’ä¼ æˆåŠŸ!';
                            uploadSpeed.textContent = '--';
                            remainingTime.textContent = 'å®Œæˆ';
                        } else {
                            uploadStatus.textContent = 'ä¸Šä¼ ä¸­...';
                            uploadSpeed.textContent = `${formatFileSize(progress.speed)}/s`;
                            remainingTime.textContent = formatTime(progress.remainingTime);
                        }

                        uploadPercentage.textContent = `${percent}%`;
                        uploadedSize.textContent = formatFileSize(progress.loaded);
                        totalSize.textContent = formatFileSize(progress.total);
                    },
                    onError: (error) => {
                        showAlert(uploadAlert, `ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                        resetUploadButtons();
                    },
                    onComplete: (fileId) => {
                        uploadStatus.textContent = 'ä¸Šä¼ å®Œæˆ!';
                        showAlert(uploadAlert, `ä¸Šä¼ æˆåŠŸ! æ–‡ä»¶ ID: ${fileId}`, 'success');
                        resetUploadButtons();
                    }
                });

                try {
                    startBtn.disabled = true;
                    pauseBtn.disabled = false;
                    cancelBtn.disabled = false;
                    await uploader.start();
                } catch (error) {
                    console.error('ä¸Šä¼ é”™è¯¯:', error);
                }
            });

            // æš‚åœä¸Šä¼ 
            pauseBtn.addEventListener('click', () => {
                uploader?.pause();
                uploadStatus.textContent = 'å·²æš‚åœ';
                pauseBtn.disabled = true;
                resumeBtn.disabled = false;
            });

            // æ¢å¤ä¸Šä¼ 
            resumeBtn.addEventListener('click', async () => {
                await uploader?.resume();
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
            });

            // å–æ¶ˆä¸Šä¼ 
            cancelBtn.addEventListener('click', async () => {
                await uploader?.cancel();
                uploadStatus.textContent = 'å·²å–æ¶ˆ';
                showAlert(uploadAlert, 'ä¸Šä¼ å·²å–æ¶ˆ', 'info');
                resetUploadButtons();
            });

            // å¼€å§‹ä¸‹è½½
            downloadBtn.addEventListener('click', async () => {
                const fileId = fileIdInput.value.trim();
                if (!fileId) {
                    showAlert(downloadAlert, 'è¯·è¾“å…¥æ–‡ä»¶ ID', 'error');
                    return;
                }

                downloader = new GridFSDownloader({
                    // url: 'https://api.example.com', // å¯é€‰: å¦‚æœåç«¯ä¸åœ¨å½“å‰åŸŸ,è¯·å¡«å†™åŸŸå
                    fileId: fileId,
                    onProgress: (progress) => {
                        downloadProgress.style.display = 'block';
                        const percent = progress.percentage.toFixed(2);
                        downloadProgressBar.style.width = `${percent}%`;
                        downloadProgressBar.textContent = `${percent}%`;

                        downloadedSize.textContent = formatFileSize(progress.loaded);
                        downloadTotalSize.textContent = formatFileSize(progress.total);
                        downloadPercentage.textContent = `${percent}%`;
                    },
                    onError: (error) => {
                        showAlert(downloadAlert, `ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                        downloadBtn.disabled = false;
                        cancelDownloadBtn.disabled = true;
                    }
                });

                try {
                    downloadBtn.disabled = true;
                    cancelDownloadBtn.disabled = false;
                    await downloader.downloadAndSave();
                    showAlert(downloadAlert, 'ä¸‹è½½å®Œæˆ!', 'success');
                    downloadBtn.disabled = false;
                    cancelDownloadBtn.disabled = true;
                } catch (error) {
                    console.error('ä¸‹è½½é”™è¯¯:', error);
                }
            });

            // å–æ¶ˆä¸‹è½½
            cancelDownloadBtn.addEventListener('click', () => {
                downloader?.cancel();
                showAlert(downloadAlert, 'ä¸‹è½½å·²å–æ¶ˆ', 'info');
                downloadBtn.disabled = false;
                cancelDownloadBtn.disabled = true;
            });

            // åŠ è½½è§†é¢‘
            loadVideoBtn.addEventListener('click', () => {
                const fileId = videoFileId.value.trim();
                if (!fileId) {
                    alert('è¯·è¾“å…¥è§†é¢‘æ–‡ä»¶ ID');
                    return;
                }

                videoPlayer.src = GridFSDownloader.getUrl(fileId);
                videoPlayer.style.display = 'block';
                videoPlayer.load();
            });

            // è¾…åŠ©å‡½æ•°
            function resetUploadButtons() {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
                cancelBtn.disabled = true;
            }

            function showAlert(element, message, type) {
                element.textContent = message;
                element.className = `alert alert-${type}`;
                element.style.display = 'block';

                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        </script>
</body>

</html>