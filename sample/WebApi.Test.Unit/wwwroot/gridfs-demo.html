<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GridFS Êñ≠ÁÇπÁª≠‰º†Á§∫‰æã</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }

            .container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }

            h1 {
                color: #333;
                margin-bottom: 10px;
                font-size: 28px;
            }

            .subtitle {
                color: #666;
                margin-bottom: 30px;
                font-size: 14px;
            }

            .upload-section,
            .download-section {
                margin-bottom: 40px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            h2 {
                color: #667eea;
                margin-bottom: 20px;
                font-size: 20px;
            }

            .file-input-wrapper {
                position: relative;
                overflow: hidden;
                display: inline-block;
                margin-bottom: 20px;
            }

            .file-input-wrapper input[type=file] {
                position: absolute;
                left: -9999px;
            }

            .file-input-label {
                padding: 12px 24px;
                background: #667eea;
                color: white;
                border-radius: 6px;
                cursor: pointer;
                transition: background 0.3s;
                display: inline-block;
            }

            .file-input-label:hover {
                background: #5568d3;
            }

            .file-name {
                display: inline-block;
                margin-left: 15px;
                color: #666;
                font-size: 14px;
            }

            .controls {
                margin-top: 20px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            button {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
                font-weight: 500;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover:not(:disabled) {
                background: #5568d3;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .btn-warning {
                background: #f59e0b;
                color: white;
            }

            .btn-warning:hover:not(:disabled) {
                background: #d97706;
            }

            .btn-success {
                background: #10b981;
                color: white;
            }

            .btn-success:hover:not(:disabled) {
                background: #059669;
            }

            .btn-danger {
                background: #ef4444;
                color: white;
            }

            .btn-danger:hover:not(:disabled) {
                background: #dc2626;
            }

            .progress-container {
                margin-top: 20px;
            }

            .progress-bar-wrapper {
                width: 100%;
                height: 30px;
                background: #e5e7eb;
                border-radius: 15px;
                overflow: hidden;
                margin-bottom: 15px;
                position: relative;
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                width: 0%;
                transition: width 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 12px;
                font-weight: bold;
            }

            .status-info {
                background: white;
                padding: 15px;
                border-radius: 6px;
                border-left: 4px solid #667eea;
            }

            .status-info div {
                margin: 5px 0;
                font-size: 14px;
                color: #333;
            }

            .status-info strong {
                color: #667eea;
                min-width: 100px;
                display: inline-block;
            }

            .download-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 6px;
                font-size: 14px;
                margin-bottom: 15px;
                transition: border-color 0.3s;
            }

            .download-input:focus {
                outline: none;
                border-color: #667eea;
            }

            .video-section {
                margin-top: 30px;
            }

            video {
                width: 100%;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .alert {
                padding: 12px;
                border-radius: 6px;
                margin-top: 15px;
                font-size: 14px;
            }

            .alert-success {
                background: #d1fae5;
                color: #065f46;
                border: 1px solid #10b981;
            }

            .alert-error {
                background: #fee2e2;
                color: #991b1b;
                border: 1px solid #ef4444;
            }

            .alert-info {
                background: #dbeafe;
                color: #1e40af;
                border: 1px solid #3b82f6;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1>üì§ GridFS Êñ≠ÁÇπÁª≠‰º†Á§∫‰æã</h1>
            <p class="subtitle">ÊîØÊåÅÂ§ßÊñá‰ª∂ÂàÜÂùó‰∏ä‰º†„ÄÅÊöÇÂÅúÊÅ¢Â§ç„ÄÅÊñ≠ÁÇπÁª≠‰º†</p>

            <!-- ‰∏ä‰º†ÈÉ®ÂàÜ -->
            <div class="upload-section">
                <h2>Êñá‰ª∂‰∏ä‰º†</h2>

                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" />
                    <label for="fileInput" class="file-input-label">üìÅ ÈÄâÊã©Êñá‰ª∂</label>
                    <span class="file-name" id="fileName">Êú™ÈÄâÊã©Êñá‰ª∂</span>
                </div>

                <div class="controls">
                    <button id="startBtn" class="btn-primary">ÂºÄÂßã‰∏ä‰º†</button>
                    <button id="pauseBtn" class="btn-warning" disabled>ÊöÇÂÅú</button>
                    <button id="resumeBtn" class="btn-success" disabled>ÊÅ¢Â§ç</button>
                    <button id="cancelBtn" class="btn-danger" disabled>ÂèñÊ∂à</button>
                </div>

                <div class="progress-container" id="uploadProgress" style="display: none;">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar">0%</div>
                    </div>
                    <div class="status-info">
                        <div>
                            <strong>Áä∂ÊÄÅ:</strong> <span id="uploadStatus">ÂáÜÂ§á‰∏≠...</span>
                        </div>
                        <div>
                            <strong>ËøõÂ∫¶:</strong> <span id="uploadPercentage">0%</span>
                        </div>
                        <div>
                            <strong>Â∑≤‰∏ä‰º†:</strong> <span id="uploadedSize">0 B</span> / <span id="totalSize">0 B</span>
                        </div>
                        <div>
                            <strong>‰∏ä‰º†ÈÄüÂ∫¶:</strong> <span id="uploadSpeed">0 B/s</span>
                        </div>
                        <div>
                            <strong>È¢ÑËÆ°Ââ©‰Ωô:</strong> <span id="remainingTime">--</span>
                        </div>
                    </div>
                </div>

                <div id="uploadAlert" style="display: none;"></div>
            </div>

            <!-- ‰∏ãËΩΩÈÉ®ÂàÜ -->
            <div class="download-section">
                <h2>Êñá‰ª∂‰∏ãËΩΩ (Êñ≠ÁÇπÁª≠‰º†)</h2>

                <input type="text" id="fileIdInput" class="download-input"
                    placeholder="ËæìÂÖ•Êñá‰ª∂ ID (Â¶Ç: 507f1f77bcf86cd799439011)" />

                <div class="controls">
                    <button id="downloadBtn" class="btn-primary">ÂºÄÂßã‰∏ãËΩΩ</button>
                    <button id="cancelDownloadBtn" class="btn-danger" disabled>ÂèñÊ∂à‰∏ãËΩΩ</button>
                </div>

                <div class="progress-container" id="downloadProgress" style="display: none;">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="downloadProgressBar">0%</div>
                    </div>
                    <div class="status-info">
                        <div>
                            <strong>Â∑≤‰∏ãËΩΩ:</strong> <span id="downloadedSize">0 B</span> /
                            <span id="downloadTotalSize">
                                0
                                B
                            </span>
                        </div>
                        <div>
                            <strong>ËøõÂ∫¶:</strong> <span id="downloadPercentage">0%</span>
                        </div>
                    </div>
                </div>

                <div id="downloadAlert" style="display: none;"></div>
            </div>

            <!-- ËßÜÈ¢ëÊí≠ÊîæÊµãËØï -->
            <div class="video-section">
                <h2>üé¨ ËßÜÈ¢ëÊµÅÂºèÊí≠ÊîæÊµãËØï</h2>
                <p class="subtitle">ËæìÂÖ•ËßÜÈ¢ëÊñá‰ª∂ ID,ÊµãËØïËåÉÂõ¥ËØ∑Ê±ÇÂíåÊãñÂä®ÂäüËÉΩ</p>

                <input type="text" id="videoFileId" class="download-input" placeholder="ËæìÂÖ•ËßÜÈ¢ëÊñá‰ª∂ ID" />

                <button id="loadVideoBtn" class="btn-primary">Âä†ËΩΩËßÜÈ¢ë</button>

                <video id="videoPlayer" controls style="margin-top: 20px; display: none;">
                    ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ
                </video>
            </div>
        </div>

        <script type="module">
            import {
                GridFSResumableUploader,
                GridFSResumableDownloader,
                formatFileSize,
                formatTime
            } from './easilynet-gridfs-sdk.js';

            let uploader = null;
            let downloader = null;

            // DOM ÂÖÉÁ¥†
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadPercentage = document.getElementById('uploadPercentage');
            const uploadedSize = document.getElementById('uploadedSize');
            const totalSize = document.getElementById('totalSize');
            const uploadSpeed = document.getElementById('uploadSpeed');
            const remainingTime = document.getElementById('remainingTime');
            const uploadAlert = document.getElementById('uploadAlert');

            // ‰∏ãËΩΩÁõ∏ÂÖ≥ÂÖÉÁ¥†
            const fileIdInput = document.getElementById('fileIdInput');
            const downloadBtn = document.getElementById('downloadBtn');
            const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
            const downloadProgress = document.getElementById('downloadProgress');
            const downloadProgressBar = document.getElementById('downloadProgressBar');
            const downloadedSize = document.getElementById('downloadedSize');
            const downloadTotalSize = document.getElementById('downloadTotalSize');
            const downloadPercentage = document.getElementById('downloadPercentage');
            const downloadAlert = document.getElementById('downloadAlert');

            // ËßÜÈ¢ëÁõ∏ÂÖ≥ÂÖÉÁ¥†
            const videoFileId = document.getElementById('videoFileId');
            const loadVideoBtn = document.getElementById('loadVideoBtn');
            const videoPlayer = document.getElementById('videoPlayer');

            // Êñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
                    startBtn.disabled = false;
                }
            });

            // ÂºÄÂßã‰∏ä‰º†
            startBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) return;

                uploader = new GridFSResumableUploader(file, {
                    // url: 'https://api.example.com', // ÂèØÈÄâ: Â¶ÇÊûúÂêéÁ´Ø‰∏çÂú®ÂΩìÂâçÂüü,ËØ∑Â°´ÂÜôÂüüÂêç
                    chunkSize: 1024 * 1024, // 1MB
                    maxConcurrent: 3,
                    onProgress: (progress) => {
                        uploadProgress.style.display = 'block';
                        const percent = progress.percentage.toFixed(2);
                        progressBar.style.width = `${percent}%`;
                        progressBar.textContent = `${percent}%`;

                        // Ê†πÊçÆÁä∂ÊÄÅÊòæÁ§∫‰∏çÂêåÁöÑÊñáÊú¨
                        if (progress.status === 'merging') {
                            uploadStatus.textContent = 'ÂêàÂπ∂Êñá‰ª∂‰∏≠,ËØ∑Á®çÂÄô...';
                            uploadSpeed.textContent = '--';
                            remainingTime.textContent = 'Ê≠£Âú®Â§ÑÁêÜ';
                        } else if (progress.status === 'hashing') {
                            uploadStatus.textContent = 'Ê≠£Âú®ËÆ°ÁÆóÊñá‰ª∂ÁâπÂæÅÂÄº(Hash)...';
                            uploadSpeed.textContent = '--';
                            remainingTime.textContent = 'ËØ∑Á®çÂÄô';
                        } else if (progress.status === 'completed') {
                            uploadStatus.textContent = 'Áßí‰º†ÊàêÂäü!';
                            uploadSpeed.textContent = '--';
                            remainingTime.textContent = 'ÂÆåÊàê';
                        } else {
                            uploadStatus.textContent = '‰∏ä‰º†‰∏≠...';
                            uploadSpeed.textContent = `${formatFileSize(progress.speed)}/s`;
                            remainingTime.textContent = formatTime(progress.remainingTime);
                        }

                        uploadPercentage.textContent = `${percent}%`;
                        uploadedSize.textContent = formatFileSize(progress.loaded);
                        totalSize.textContent = formatFileSize(progress.total);
                    },
                    onError: (error) => {
                        showAlert(uploadAlert, `‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'error');
                        resetUploadButtons();
                    },
                    onComplete: (fileId) => {
                        uploadStatus.textContent = '‰∏ä‰º†ÂÆåÊàê!';
                        showAlert(uploadAlert, `‰∏ä‰º†ÊàêÂäü! Êñá‰ª∂ ID: ${fileId}`, 'success');
                        resetUploadButtons();
                    }
                });

                try {
                    startBtn.disabled = true;
                    pauseBtn.disabled = false;
                    cancelBtn.disabled = false;
                    await uploader.start();
                } catch (error) {
                    console.error('‰∏ä‰º†ÈîôËØØ:', error);
                }
            });

            // ÊöÇÂÅú‰∏ä‰º†
            pauseBtn.addEventListener('click', () => {
                uploader?.pause();
                uploadStatus.textContent = 'Â∑≤ÊöÇÂÅú';
                pauseBtn.disabled = true;
                resumeBtn.disabled = false;
            });

            // ÊÅ¢Â§ç‰∏ä‰º†
            resumeBtn.addEventListener('click', async () => {
                await uploader?.resume();
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
            });

            // ÂèñÊ∂à‰∏ä‰º†
            cancelBtn.addEventListener('click', async () => {
                await uploader?.cancel();
                uploadStatus.textContent = 'Â∑≤ÂèñÊ∂à';
                showAlert(uploadAlert, '‰∏ä‰º†Â∑≤ÂèñÊ∂à', 'info');
                resetUploadButtons();
            });

            // ÂºÄÂßã‰∏ãËΩΩ
            downloadBtn.addEventListener('click', async () => {
                const fileId = fileIdInput.value.trim();
                if (!fileId) {
                    showAlert(downloadAlert, 'ËØ∑ËæìÂÖ•Êñá‰ª∂ ID', 'error');
                    return;
                }

                downloader = new GridFSResumableDownloader({
                    // url: 'https://api.example.com', // ÂèØÈÄâ: Â¶ÇÊûúÂêéÁ´Ø‰∏çÂú®ÂΩìÂâçÂüü,ËØ∑Â°´ÂÜôÂüüÂêç
                    fileId: fileId,
                    onProgress: (progress) => {
                        downloadProgress.style.display = 'block';
                        const percent = progress.percentage.toFixed(2);
                        downloadProgressBar.style.width = `${percent}%`;
                        downloadProgressBar.textContent = `${percent}%`;

                        downloadedSize.textContent = formatFileSize(progress.loaded);
                        downloadTotalSize.textContent = formatFileSize(progress.total);
                        downloadPercentage.textContent = `${percent}%`;
                    },
                    onError: (error) => {
                        showAlert(downloadAlert, `‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`, 'error');
                        downloadBtn.disabled = false;
                        cancelDownloadBtn.disabled = true;
                    }
                });

                try {
                    downloadBtn.disabled = true;
                    cancelDownloadBtn.disabled = false;
                    await downloader.downloadAndSave();
                    showAlert(downloadAlert, '‰∏ãËΩΩÂÆåÊàê!', 'success');
                    downloadBtn.disabled = false;
                    cancelDownloadBtn.disabled = true;
                } catch (error) {
                    console.error('‰∏ãËΩΩÈîôËØØ:', error);
                }
            });

            // ÂèñÊ∂à‰∏ãËΩΩ
            cancelDownloadBtn.addEventListener('click', () => {
                downloader?.cancel();
                showAlert(downloadAlert, '‰∏ãËΩΩÂ∑≤ÂèñÊ∂à', 'info');
                downloadBtn.disabled = false;
                cancelDownloadBtn.disabled = true;
            });

            // Âä†ËΩΩËßÜÈ¢ë
            loadVideoBtn.addEventListener('click', () => {
                const fileId = videoFileId.value.trim();
                if (!fileId) {
                    alert('ËØ∑ËæìÂÖ•ËßÜÈ¢ëÊñá‰ª∂ ID');
                    return;
                }

                videoPlayer.src = GridFSResumableDownloader.getUrl(fileId);
                videoPlayer.style.display = 'block';
                videoPlayer.load();
            });

            // ËæÖÂä©ÂáΩÊï∞
            function resetUploadButtons() {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
                cancelBtn.disabled = true;
            }

            function showAlert(element, message, type) {
                element.textContent = message;
                element.className = `alert alert-${type}`;
                element.style.display = 'block';

                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        </script>
    </body>

</html>