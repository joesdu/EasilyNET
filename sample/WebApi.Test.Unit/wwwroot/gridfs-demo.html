<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridFS ç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            color-scheme: light;
            --bg: #0f172a;
            --surface: #0b1220;
            --card: #111827;
            --card-alt: #0f172a;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --primary: #60a5fa;
            --primary-strong: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #1f2937;
            --ring: rgba(96, 165, 250, 0.35);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 32px 20px 60px;
            background: radial-gradient(1200px 600px at 10% 10%, rgba(96, 165, 250, 0.2), transparent), radial-gradient(900px 500px at 90% 10%, rgba(34, 197, 94, 0.15), transparent), #0b1120;
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: 18px;
            padding: 32px;
            box-shadow: 0 18px 50px rgba(8, 15, 31, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        h1 {
            color: var(--text);
            margin-bottom: 8px;
            font-size: 30px;
            letter-spacing: 0.3px;
        }

        .subtitle {
            color: var(--muted);
            margin-bottom: 28px;
            font-size: 14px;
        }

        .upload-section,
        .download-section,
        .video-section {
            margin-bottom: 26px;
            padding: 22px 22px 20px;
            background: var(--card);
            border-radius: 14px;
            border: 1px solid var(--border);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
        }

        h2 {
            color: var(--primary);
            margin-bottom: 18px;
            font-size: 20px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 18px;
        }

            .file-input-wrapper input[type=file] {
                position: absolute;
                left: -9999px;
            }

        .drop-zone {
            border: 1px dashed rgba(148, 163, 184, 0.4);
            border-radius: 14px;
            padding: 22px;
            background: var(--card-alt);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
        }

            .drop-zone.dragover {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--ring);
                background: rgba(59, 130, 246, 0.08);
            }

        .file-input-label {
            padding: 12px 20px;
            background: var(--primary);
            color: #0b1120;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

            .file-input-label:hover {
                background: var(--primary-strong);
                transform: translateY(-1px);
                box-shadow: 0 8px 20px rgba(59, 130, 246, 0.35);
            }

        .file-name {
            color: var(--text);
            font-size: 14px;
        }

        .file-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .file-sub {
            color: var(--muted);
            font-size: 12px;
        }

        .controls {
            margin-top: 16px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 600;
        }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        .btn-primary {
            background: var(--primary);
            color: #0b1120;
        }

            .btn-primary:hover:not(:disabled) {
                background: var(--primary-strong);
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
            }

        .btn-warning {
            background: var(--warning);
            color: #0b1120;
        }

            .btn-warning:hover:not(:disabled) {
                background: #d97706;
            }

        .btn-success {
            background: var(--success);
            color: #0b1120;
        }

            .btn-success:hover:not(:disabled) {
                background: #059669;
            }

        .btn-danger {
            background: var(--danger);
            color: #0b1120;
        }

            .btn-danger:hover:not(:disabled) {
                background: #dc2626;
            }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #111827;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #60a5fa 0%, #22c55e 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0b1120;
            font-size: 12px;
            font-weight: bold;
        }

        .status-info {
            background: rgba(15, 23, 42, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

            .status-info div {
                margin: 6px 0;
                font-size: 14px;
                color: var(--text);
                display: flex;
                justify-content: space-between;
                gap: 12px;
            }

            .status-info strong {
                color: var(--primary);
                min-width: 90px;
                display: inline-block;
            }

        .download-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: rgba(15, 23, 42, 0.8);
            color: var(--text);
        }

            .download-input:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--ring);
            }

        .video-section {
            margin-top: 26px;
        }

        video {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
        }

        .alert {
            padding: 12px 14px;
            border-radius: 10px;
            margin-top: 12px;
            font-size: 14px;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.18);
            color: #bbf7d0;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.16);
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, 0.35);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.15);
            color: #bfdbfe;
            border: 1px solid rgba(59, 130, 246, 0.35);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(96, 165, 250, 0.15);
            color: #bfdbfe;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .hint-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .link-button {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            padding: 0;
        }

            .link-button:hover {
                color: var(--primary-strong);
                text-decoration: underline;
            }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(15, 23, 42, 0.7);
            color: var(--muted);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

            .chip strong {
                color: var(--text);
            }

        .error-details {
            margin-top: 12px;
            padding: 12px;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.12);
            border: 1px dashed rgba(239, 68, 68, 0.4);
            color: #fecaca;
            display: none;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .error-details-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #fecaca;
        }

        .error-actions {
            display: flex;
            gap: 8px;
        }

        .ghost-button {
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.45);
            background: rgba(239, 68, 68, 0.15);
            color: #fecaca;
            font-size: 12px;
            cursor: pointer;
        }

            .ghost-button:hover {
                background: rgba(239, 68, 68, 0.25);
            }

        .muted {
            color: var(--muted);
        }

        @media (max-width: 640px) {
            .controls {
                flex-direction: column;
            }

            .drop-zone {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“¤ GridFS ç¤ºä¾‹</h1>
        <p class="subtitle">æ”¯æŒå¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ ã€æš‚åœæ¢å¤ã€æ–­ç‚¹ç»­ä¼ </p>

        <!-- ä¸Šä¼ éƒ¨åˆ† -->
        <div class="upload-section">
            <div class="section-header">
                <h2>æ–‡ä»¶ä¸Šä¼ </h2>
                <span class="badge">æ”¯æŒæ–­ç‚¹ç»­ä¼ </span>
            </div>

            <div class="file-input-wrapper">
                <input type="file" id="fileInput" />
                <div class="drop-zone" id="dropZone">
                    <label for="fileInput" class="file-input-label">ğŸ“ é€‰æ‹©æ–‡ä»¶</label>
                    <div class="file-meta">
                        <span class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
                        <span class="file-sub">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </span>
                    </div>
                </div>
            </div>

            <div class="hint">é»˜è®¤å¯ç”¨é­”æ•°æ ¡éªŒï¼›æ‰©å±•åä¸å†…å®¹ç±»å‹ä¸ä¸€è‡´ä¼šæç¤ºå¤±è´¥ã€‚</div>
            <div class="hint-row">
                <span class="chip">æœ€å¤§å¤§å°ï¼š<strong id="maxFileSizeHint">512 MB</strong></span>
                <span class="chip">å…è®¸æ‰©å±•åï¼š<strong id="allowedExtensionsHint">åŠ è½½ä¸­...</strong></span>
                <button class="link-button" id="toggleExtensions">å±•å¼€å…¨éƒ¨</button>
            </div>

            <div class="controls">
                <button id="startBtn" class="btn-primary">å¼€å§‹ä¸Šä¼ </button>
                <button id="pauseBtn" class="btn-warning" disabled>æš‚åœ</button>
                <button id="resumeBtn" class="btn-success" disabled>æ¢å¤</button>
                <button id="cancelBtn" class="btn-danger" disabled>å–æ¶ˆ</button>
            </div>

            <div class="progress-container" id="uploadProgress" style="display: none;">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="status-info">
                    <div>
                        <strong>çŠ¶æ€:</strong> <span id="uploadStatus">å‡†å¤‡ä¸­...</span>
                    </div>
                    <div>
                        <strong>è¿›åº¦:</strong> <span id="uploadPercentage">0%</span>
                    </div>
                    <div>
                        <strong>å·²ä¸Šä¼ :</strong> <span id="uploadedSize">0 B</span> / <span id="totalSize">0 B</span>
                    </div>
                    <div>
                        <strong>ä¸Šä¼ é€Ÿåº¦:</strong> <span id="uploadSpeed">0 B/s</span>
                    </div>
                    <div>
                        <strong>é¢„è®¡å‰©ä½™:</strong> <span id="remainingTime">--</span>
                    </div>
                </div>
            </div>

            <div id="uploadAlert" style="display: none;"></div>
            <div id="uploadErrorDetails" class="error-details">
                <div class="error-details-header">
                    <span>è¯¦ç»†é”™è¯¯</span>
                    <div class="error-actions">
                        <button class="ghost-button" id="copyErrorBtn">å¤åˆ¶</button>
                    </div>
                </div>
                <div id="uploadErrorText"></div>
            </div>
        </div>

        <!-- ä¸‹è½½éƒ¨åˆ† -->
        <div class="download-section">
            <div class="section-header">
                <h2>æ–‡ä»¶ä¸‹è½½ (æ–­ç‚¹ç»­ä¼ )</h2>
                <span class="badge">Range æ”¯æŒ</span>
            </div>

            <input type="text" id="fileIdInput" class="download-input"
                   placeholder="è¾“å…¥æ–‡ä»¶ ID (å¦‚: 507f1f77bcf86cd799439011)" />

            <div class="controls">
                <button id="downloadBtn" class="btn-primary">å¼€å§‹ä¸‹è½½</button>
                <button id="cancelDownloadBtn" class="btn-danger" disabled>å–æ¶ˆä¸‹è½½</button>
            </div>

            <div class="progress-container" id="downloadProgress" style="display: none;">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="downloadProgressBar">0%</div>
                </div>
                <div class="status-info">
                    <div>
                        <strong>å·²ä¸‹è½½:</strong> <span id="downloadedSize">0 B</span> /
                        <span id="downloadTotalSize">
                            0
                            B
                        </span>
                    </div>
                    <div>
                        <strong>è¿›åº¦:</strong> <span id="downloadPercentage">0%</span>
                    </div>
                </div>
            </div>

            <div id="downloadAlert" style="display: none;"></div>
        </div>

        <!-- è§†é¢‘æ’­æ”¾æµ‹è¯• -->
        <div class="video-section">
            <div class="section-header">
                <h2>ğŸ¬ è§†é¢‘æµå¼æ’­æ”¾æµ‹è¯•</h2>
                <span class="badge">Streaming</span>
            </div>
            <p class="subtitle">è¾“å…¥è§†é¢‘æ–‡ä»¶ ID,æµ‹è¯•èŒƒå›´è¯·æ±‚å’Œæ‹–åŠ¨åŠŸèƒ½</p>

            <input type="text" id="videoFileId" class="download-input" placeholder="è¾“å…¥è§†é¢‘æ–‡ä»¶ ID" />

            <button id="loadVideoBtn" class="btn-primary">åŠ è½½è§†é¢‘</button>

            <video id="videoPlayer" controls style="margin-top: 20px; display: none;">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
            </video>
        </div>
    </div>

    <script type="module">
        import {
            GridFSUploader,
            GridFSDownloader,
            formatFileSize,
            formatTime
        } from './easilynet-gridfs-sdk.js';

        let uploader = null;
        let downloader = null;

        // DOM å…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadPercentage = document.getElementById('uploadPercentage');
        const uploadedSize = document.getElementById('uploadedSize');
        const totalSize = document.getElementById('totalSize');
        const uploadSpeed = document.getElementById('uploadSpeed');
        const remainingTime = document.getElementById('remainingTime');
        const uploadAlert = document.getElementById('uploadAlert');
        const dropZone = document.getElementById('dropZone');
        const uploadErrorDetails = document.getElementById('uploadErrorDetails');
        const uploadErrorText = document.getElementById('uploadErrorText');
        const maxFileSizeHint = document.getElementById('maxFileSizeHint');
        const allowedExtensionsHint = document.getElementById('allowedExtensionsHint');
        const toggleExtensions = document.getElementById('toggleExtensions');
        const copyErrorBtn = document.getElementById('copyErrorBtn');

        // ä¸‹è½½ç›¸å…³å…ƒç´ 
        const fileIdInput = document.getElementById('fileIdInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
        const downloadProgress = document.getElementById('downloadProgress');
        const downloadProgressBar = document.getElementById('downloadProgressBar');
        const downloadedSize = document.getElementById('downloadedSize');
        const downloadTotalSize = document.getElementById('downloadTotalSize');
        const downloadPercentage = document.getElementById('downloadPercentage');
        const downloadAlert = document.getElementById('downloadAlert');

        // è§†é¢‘ç›¸å…³å…ƒç´ 
        const videoFileId = document.getElementById('videoFileId');
        const loadVideoBtn = document.getElementById('loadVideoBtn');
        const videoPlayer = document.getElementById('videoPlayer');

        const maxFileSize = 512 * 1024 * 1024; // 512MB ç¤ºä¾‹é™åˆ¶
        const allowedExtensions = [
            '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.tif', '.tiff', '.heic', '.heif', '.svg', '.psd', '.ai',
            '.pdf',
            '.mp3', '.wav', '.flac', '.ogg', '.oga', '.opus', '.aac',
            '.mp4', '.m4v', '.mov', '.avi', '.mkv', '.webm', '.flv',
            '.zip', '.7z', '.rar', '.gz', '.tar', '.apk', '.jar', '.war', '.epub',
            '.docx', '.xlsx', '.pptx', '.mobi',
            '.exe', '.dll', '.msi', '.cab', '.elf', '.macho', '.wasm',
            '.iso', '.dmg', '.dwg', '.dxf'
        ];

        maxFileSizeHint.textContent = formatFileSize(maxFileSize);
        let extensionsExpanded = false;
        function renderExtensionsHint() {
            if (extensionsExpanded) {
                allowedExtensionsHint.textContent = allowedExtensions.join(', ');
                toggleExtensions.textContent = 'æ”¶èµ·';
            } else {
                allowedExtensionsHint.textContent = allowedExtensions.slice(0, 10).join(', ') + '...';
                toggleExtensions.textContent = 'å±•å¼€å…¨éƒ¨';
            }
        }
        renderExtensionsHint();

        toggleExtensions.addEventListener('click', () => {
            extensionsExpanded = !extensionsExpanded;
            renderExtensionsHint();
        });

        function normalizeExt(name) {
            const index = name.lastIndexOf('.');
            if (index === -1) return '';
            return name.slice(index).toLowerCase();
        }

        function validateFile(file) {
            if (file.size > maxFileSize) {
                return `æ–‡ä»¶è¶…è¿‡é™åˆ¶: ${formatFileSize(maxFileSize)}`;
            }
            const ext = normalizeExt(file.name);
            if (allowedExtensions.length > 0 && ext && !allowedExtensions.includes(ext)) {
                return `ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${ext}`;
            }
            return '';
        }

        function handleFileSelection(file) {
            if (!file) return;
            const error = validateFile(file);
            if (error) {
                showAlert(uploadAlert, error, 'error');
                showErrorDetails(error);
                startBtn.disabled = true;
                return;
            }
            hideErrorDetails();
            fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
            startBtn.disabled = false;
        }

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFileSelection(file);
        });

        // æ‹–æ‹½ä¸Šä¼ 
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelection(file);
            }
        });

        // å¼€å§‹ä¸Šä¼ 
        startBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) return;

            uploader = new GridFSUploader(file, {
                // url: 'https://api.example.com', // å¯é€‰: å¦‚æœåç«¯ä¸åœ¨å½“å‰åŸŸ,è¯·å¡«å†™åŸŸå
                chunkSize: 1024 * 1024, // 1MB
                maxConcurrent: 3,
                maxFileSize,
                allowedExtensions,
                enableMagicNumberValidation: true,
                onProgress: (progress) => {
                    uploadProgress.style.display = 'block';
                    const percentValue = (progress.status === 'hashing' && typeof progress.hashPercentage === 'number')
                        ? progress.hashPercentage
                        : progress.percentage;
                    const percent = percentValue.toFixed(2);
                    progressBar.style.width = `${percent}%`;
                    progressBar.textContent = `${percent}%`;

                    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬
                    if (progress.status === 'merging') {
                        uploadStatus.textContent = 'åˆå¹¶æ–‡ä»¶ä¸­,è¯·ç¨å€™...';
                        uploadSpeed.textContent = '--';
                        remainingTime.textContent = 'æ­£åœ¨å¤„ç†';
                    } else if (progress.status === 'hashing') {
                        uploadStatus.textContent = `æ­£åœ¨è®¡ç®—æ–‡ä»¶ç‰¹å¾å€¼(Hash)... ${percent}%`;
                        uploadSpeed.textContent = '--';
                        remainingTime.textContent = 'è¯·ç¨å€™';
                    } else if (progress.status === 'completed') {
                        uploadStatus.textContent = 'ç§’ä¼ æˆåŠŸ!';
                        uploadSpeed.textContent = '--';
                        remainingTime.textContent = 'å®Œæˆ';
                    } else {
                        uploadStatus.textContent = 'ä¸Šä¼ ä¸­...';
                        uploadSpeed.textContent = `${formatFileSize(progress.speed)}/s`;
                        remainingTime.textContent = formatTime(progress.remainingTime);
                    }

                    uploadPercentage.textContent = `${percent}%`;
                    uploadedSize.textContent = formatFileSize(progress.loaded);
                    totalSize.textContent = formatFileSize(progress.total);
                },
                onValidationError: (message) => {
                    showAlert(uploadAlert, message, 'error');
                    showErrorDetails(message);
                    resetUploadButtons();
                },
                onError: (error) => {
                    showAlert(uploadAlert, `ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                    showErrorDetails(error.message);
                    resetUploadButtons();
                },
                onComplete: (fileId) => {
                    uploadStatus.textContent = 'ä¸Šä¼ å®Œæˆ!';
                    showAlert(uploadAlert, `ä¸Šä¼ æˆåŠŸ! æ–‡ä»¶ ID: ${fileId}`, 'success');
                    resetUploadButtons();
                }
            });

            try {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                cancelBtn.disabled = false;
                await uploader.start();
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
            }
        });

        // æš‚åœä¸Šä¼ 
        pauseBtn.addEventListener('click', () => {
            uploader?.pause();
            uploadStatus.textContent = 'å·²æš‚åœ';
            pauseBtn.disabled = true;
            resumeBtn.disabled = false;
        });

        // æ¢å¤ä¸Šä¼ 
        resumeBtn.addEventListener('click', async () => {
            await uploader?.resume();
            pauseBtn.disabled = false;
            resumeBtn.disabled = true;
        });

        // å–æ¶ˆä¸Šä¼ 
        cancelBtn.addEventListener('click', async () => {
            await uploader?.cancel();
            uploadStatus.textContent = 'å·²å–æ¶ˆ';
            showAlert(uploadAlert, 'ä¸Šä¼ å·²å–æ¶ˆ', 'info');
            resetUploadButtons();
        });

        // å¼€å§‹ä¸‹è½½
        downloadBtn.addEventListener('click', async () => {
            const fileId = fileIdInput.value.trim();
            if (!fileId) {
                showAlert(downloadAlert, 'è¯·è¾“å…¥æ–‡ä»¶ ID', 'error');
                return;
            }

            downloader = new GridFSDownloader({
                // url: 'https://api.example.com', // å¯é€‰: å¦‚æœåç«¯ä¸åœ¨å½“å‰åŸŸ,è¯·å¡«å†™åŸŸå
                fileId: fileId,
                onProgress: (progress) => {
                    downloadProgress.style.display = 'block';
                    const percent = progress.percentage.toFixed(2);
                    downloadProgressBar.style.width = `${percent}%`;
                    downloadProgressBar.textContent = `${percent}%`;

                    downloadedSize.textContent = formatFileSize(progress.loaded);
                    downloadTotalSize.textContent = formatFileSize(progress.total);
                    downloadPercentage.textContent = `${percent}%`;
                },
                onError: (error) => {
                    showAlert(downloadAlert, `ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                    downloadBtn.disabled = false;
                    cancelDownloadBtn.disabled = true;
                }
            });

            try {
                downloadBtn.disabled = true;
                cancelDownloadBtn.disabled = false;
                await downloader.downloadAndSave();
                showAlert(downloadAlert, 'ä¸‹è½½å®Œæˆ!', 'success');
                downloadBtn.disabled = false;
                cancelDownloadBtn.disabled = true;
            } catch (error) {
                console.error('ä¸‹è½½é”™è¯¯:', error);
            }
        });

        // å–æ¶ˆä¸‹è½½
        cancelDownloadBtn.addEventListener('click', () => {
            downloader?.cancel();
            showAlert(downloadAlert, 'ä¸‹è½½å·²å–æ¶ˆ', 'info');
            downloadBtn.disabled = false;
            cancelDownloadBtn.disabled = true;
        });

        // åŠ è½½è§†é¢‘
        loadVideoBtn.addEventListener('click', () => {
            const fileId = videoFileId.value.trim();
            if (!fileId) {
                alert('è¯·è¾“å…¥è§†é¢‘æ–‡ä»¶ ID');
                return;
            }

            videoPlayer.src = GridFSDownloader.getUrl(fileId);
            videoPlayer.style.display = 'block';
            videoPlayer.load();
        });

        // è¾…åŠ©å‡½æ•°
        function resetUploadButtons() {
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            resumeBtn.disabled = true;
            cancelBtn.disabled = true;
        }

        function showAlert(element, message, type) {
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.style.display = 'block';

            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function showErrorDetails(message) {
            uploadErrorText.textContent = message;
            uploadErrorDetails.style.display = 'block';
        }

        function hideErrorDetails() {
            uploadErrorDetails.style.display = 'none';
            uploadErrorText.textContent = '';
        }

        copyErrorBtn.addEventListener('click', async () => {
            const text = uploadErrorText.textContent || '';
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);
                copyErrorBtn.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => {
                    copyErrorBtn.textContent = 'å¤åˆ¶';
                }, 1200);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥', err);
            }
        });
    </script>
</body>

</html>
